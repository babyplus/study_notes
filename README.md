# 内核_中断和异常_Interrupts_and_Exceptions  

*20230728*  

Interrupts are often devided into synchronous and asynchronous interrupts:

* Synchronous interrupts are produced by the CPU control unit while executing instructions and are called synchronous because the control unit issues them only after terminating the execution of an instruction
* Asynchronous interrupts are generated by other hardware devices at arbitrary times with respect to the CPU clock signals

中断通常分为同步中断和异步中断：

* 同步中断是指当指令执行时由CPU控制单元产生的，之所以称为同步，是因为只有在一条指令终止执行后CPU才会发出中断
* 异步中断是由其他硬件设备依照CPU时钟信号随机产生的

## 中断信号的作用 The Role of Interrupt Signals

When a interrupt signal arrives, the CPU must stop what it`s currently doing and switch to a new activity.

当一个中断信号达到时，CPU必须停止它当前正在做的事情，并且切换到一个新的活动。

## 中断和异常 Interrupts and Exceptions

Intel microprocessor manuals designate synchronous and asynchronous interrupts as exceptions and interrupts.

在Intel微处理器手册中，同步中断被称为异常，异步中断被称为中断。

Exceptions are caused either by programming errors or by anomalous conditions that must be handled by the kernel

* Faults
* Traps
* Aborts
* Programmed exceptions

异常：由程序产生的或者是由内核必须处理的异常条件产生的

* 故障
* 陷阱
* 异常中止
* 编程异常

Interrupts are issued by interval timers and I/O devices

* Maskable interrupts
* Nonmaskable interrupts

中断：由间隔定时器和I/O设备产生的

* 可屏蔽中断
* 非屏蔽中断

Each exception or interrupt is identified by a number ranging from 0 to 255.

每个异常和中断是由0~255之间的一个数来标识。

### IRQ和中断 IRQs and Interrupts

Each hardware device controller is capable of issuing interrupt requests, usually, a single or several output lines designated as the Interrupt ReQuest(IRQ) line.All existing IRQ lines are connected to the input pins of a hardware circuit called the Programmable Interrupt Controller.

每个能够发出中断请求的硬件设备控制器都有一条或多条名为Interrupt ReQuest（IRQ）的输出线。所有现有的IRQ线都与一个名为可编程中断控制器（Programmable Interrupt Controller, PIC）的硬件电路的输入引脚相连。

Programmable Interrupt Controller performs the following actions:

* Monitors the IRQ lines, checking for raised signals
* Converts the raised signal received into a corresponding vector
* Stores the vector in an Interrupt Controller I/O port, thus allowing the CPU to read it via the data bus
* Sends a raised signal to the processor INTR pin, that is, issue an interrupt
* Waits until the CPU acknowledges the interrupt signal by writing into one of Programmable Interrupt Controllers I/O ports; when this occurs, clears the INTR line.

可编程中断控制器执行下列动作：

* 监视IRQ线，检查产生的信号（raised signal）
* 把接收到引发信号转换成对应的向量
* 把这个向量存放在中断控制器的一个I/O端口，从而允许CPU通过数据总线读此向量
* 把引发信号发送到处理器的INTR引脚，即产生一个中断
* 等待，直到CPU通过把这个中断信号写进可编程中断控制器的一个I/O端口来确认它；当这种情况发生时，清INTR线

#### 高级可编程中断控制器 The Advanced Programmable Interrupt Controller (APIC)

Being able to deliver interrupts to each CPU in the system is crucial for fully exploiting the parallelism of the SMP architecture. For that reason, Intel introduced starting with Pentium 3 a new component designated as the I/O Advanced Programmable Interrupt Controller.

从奔腾3开始引入I/O高级可编程控制器把中断传递给系统中的每个CPU。

All current 80x86 microprocessors include a local APIC. Each local APIC has 32-bit registers; an internal clock; a local timer device; and two additional IRQ lines(LINT0 and LINT1) reserved for local APIC interrupts. All local APICs are connected an external I/O APIC, giving rise to a multi-APIC system.

80x86微处理器当前所有的CPU都含有一个本地APIC，每个本地APIC都有32位的寄存器、一个内部时钟、一个本地定时器及为本地APIC中断保留的两条额外的IRQ线LINT0和LINT1。所有本地APIC都连接到一个外部I/O APIC，形成一个多APIC的系统。

I/O APIC components:

* a set of 24 IRQ lines
* a 24-entry Interrupt Redirection Table
* programmable registers
* a message unit for sending and receiving APIC messages over the APIC bus

I/O APIC的组成：

* 一组24条IRQ线
* 一张24项的中断重定向表（Interrupt Redirection Table）
* 可编程寄存器
* 通过APIC总线发送和接收APIC信息的一个信息单元

Each entry in the Redirection Table can be individually programmed to indicate the interrupt vector and priority, the destination processor, and how the processor is selected.

中断重定向表中的每一项都可以被单独编程以指明中断向量和优先级、目标处理器及选择处理器的方式。

The information in the Redirection Table is used to translate each external IRQ signal into a message to one or more local APIC units via the APIC bus.

重定向表中的信息用于把每个外部IRQ信号转换为一条消息，然后，通过APIC总线把消息发送给一个或多个本地APIC单元。

Interrupt requests coming from external hardware devices can be distributed among the available CPUs in two ways:

* Static distribution
* Dynamic distribution

来自外部硬件设备的中断请求以两种方式在可用的CPU之间分发：

* 静态方式
* 动态方式

### 异常 Exceptions

The 80x86 microprocessors issue roughly 20 different exceptions. The kernel must provide a dedicated exception handler for each exception type.

80x86微处理器发布了大约20种不同的异常。内核必须为每种异常提供一个专门的异常处理程序。

For some exceptions,  the CPU control unit also generates a hardware error code and pushed it on the Kernel Mode stack before starting the exception handler.

对于某些异常，CPU控制单元在开始执行异常处理程序前会产生一个硬件出错码，并且压入内核态堆栈。

### 中断描述符表 Interrupt Descriptor Table (IDT)

A system table called Interrupt Descriptor Table associates each interrupt or exception vector with the address of the corresponding interrupt or exception handler.

中断描述符表是一个系统表，它与每一个中断或异常向量相联系，每一个向量在表中有相应的中断或异常处理程序的入口。

The IDT must be properly initialized before the kernel enables interrupts.

内核在允许发生中断前，必须先初始化IDT。

The IDT include three types of descriptors:

* Task gate
* Interrupt gate
* Trap gate

IDT包含三种类型的描述符：

* 任务门
* 中断门
* 陷阱门

### 中断和异常的硬件处理 Hardware Handling of Interrupts and Exceptions

The kernel has been initialized and the CPU is operating in Protected Mode.

内核已经被初始化，CPU在保护模式下运行。

After executing an instruction, the cs and eip pair of registers contain the logical address of the next instruction to be executed.

当执行了一条指令后，cs和eip这对寄存器包含下一个将要执行的指令的逻辑地址。

Before dealing with instruction, the control unit checks whether an interrupt or an exception occurred while the control unit executed the previous instruction.

在处理指令之前，控制单元会检查在运行前一条指令时是否已经发生了一个中断或者异常。

If an interrupt or an exception occurred, the control unit does the following:

* Determines the vector i associated with the interrupt or the exception
* Reads the entry of the IDT referred by the idtr register
* Gets the base address of the GDT from the gdtr register and looks in the GDT to read the Segment Descriptor identified by the selector in the IDT entry
* Makes sure the interrupt was issued by an authorized source
* Checks whether a change of privilege level is taking place, if so, the control unit must start using the stack that is associated with the new privilege level
* If a fault has occurred, it loads cs and eip with the logical address of the instruction that caused the exception so that it can be executed again
* Saves the contents of eflags, cs, eip in the stack
* If the exception carries a hardware error code, it saves it on the stack
* Loads cs and eip

如果发生了一个中断或异常，那么控制单元执行下列操作：

* 确定与中断或异常关联的向量i
* 读取由idtr寄存器指向的IDT表中的第i项
* 从gdtr寄存器获得GDT的基地址，并在GDT中查找，以读取IDT表项中的选择符所标识的段描述符
* 确信中断是由授权的（中断）发生源发出的
* 检查是否发生了特权级的变化，如果是，控制单元必须开始使用与新的特权级相关的栈
* 如果故障已发生，用引起异常的指令地址装载cs和eip寄存器，从而使得这条指令能再次被执行
* 在栈中保存eflags、cs及eip的内容
* 如果产生了一个硬件出错码，则将它保存在栈中
* 装载cs和eip寄存器，其值分别是IDT表中的第i项门描述符的段选择符和偏移量字段

## 中断和异常处理程序的嵌套执行 Nested Execution of Exception and Interrupt Handles

每个中断或异常都会引起一个内核控制路径，或者说代表当前进程在内核态执行单独的指令序列。

当I/O设备发出一个中断时，相应的内核控制路径的第一部分指令就是那些把寄存器的内容保存在内核堆栈的指令，而最后一部分指令就是恢复寄存器内容并让CPU返回到用户态的那些指令。

## 初始化中断描述符表 Initiallizing the Interrupt Descriptor Table

内核启用中断前，把IDT表的初始地址装到idtr寄存器，并初始化表中的每一项。

int指令允许用户进程发出一个中断信号，为了防止用户模拟非法中断和异常，IDT的初始化必须非常小心，可以通过把中断和陷阱门描述符的DPL字段设置成0来实现。

### 中断门、陷阱门及系统门 Interrupt,Trap, and System Gates

Intel提供了三种类型的中断描述符，而Linux进行了如下分类：

* 中断门
* 系统门
* 系统中断门
* 陷阱门
* 任务门

### IDT的初步初始化 Preliminary Initialization of the IDT

当计算机还运行在实模式时，IDT被初始化并由BIOS例程使用。一旦Linux接管，IDT就被移到RAM的另一个区域，并进行第二次初始化。

## 异常处理 Exception Handling

### 为异常处理程序保存寄存器的值 Saving the Registers for the Exception Handler

### 进入和离开异常处理程序 Entering and Leaving the Exception Handler

## 中断处理 Interrupt Handling

### I/O中断处理 I/O Interrupte Handling

### 处理器间中断处理 Interprocessor Interrupt Handling

## 软中断及tasklet Softirqs and Tasklets

### 软中断 Softirqs

### Tasklets

## 工作队列 Work Queues

## 从中断和异常返回 Returning from Interrupts and Exceptions
